<%#-- copyright
OpenProject Backlogs Plugin

Copyright (C)2013-2014 the OpenProject Foundation (OPF)
Copyright (C)2011 Stephan Eckardt, Tim Felgentreff, Marnen Laibow-Koser, Sandro Munda
Copyright (C)2010-2011 friflaj
Copyright (C)2010 Maxime Guilbot, Andrew Vit, Joakim KolsjÃ¶, ibussieres, Daniel Passos, Jason Vasquez, jpic, Emiliano Heyns
Copyright (C)2009-2010 Mark Maglana
Copyright (C)2009 Joe Heck, Nate Lowrie

This program is free software; you can redistribute it and/or modify it under
the terms of the GNU General Public License version 3.

OpenProject Backlogs is a derivative work based on ChiliProject Backlogs.
The copyright follows:
Copyright (C) 2010-2011 - Emiliano Heyns, Mark Maglana, friflaj
Copyright (C) 2011 - Jens Ulferts, Gregor Schmidt - Finn GmbH - Berlin, Germany

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

See doc/COPYRIGHT.rdoc for more details.

++#%>

<% content_for :header_tags do %>
  <%= render :partial => 'shared/backlogs_header' %>
  <%= stylesheet_link_tag 'backlogs/taskboard.css' %>
<% end %>
<% html_title @sprint.name %>

<%= toolbar title: @sprint.name do %> 
  <% if @sprint.has_burndown? %>  
  <li class="toolbar-item">
    <div class="tooltips">
    <a><i class="button--icon icon-time" aria-hidden="true"></i>
    <% if (DateTime.now <= @sprint.effective_date) %>
      <%= distance_of_time_in_words(@sprint.effective_date, DateTime.now) %> remaining 
    <% else %>
       completed <%= distance_of_time_in_words(@sprint.effective_date, DateTime.now) %> ago
    <% end %>
      <ul>
        <li>Start Date:</li>
        <li class="space"><%= @sprint.start_date %></li>
        <li>Projected End Date:</li>
        <li><%= @sprint.effective_date %></li>
      </ul> 
    </a> 
    </div>
    </li>
  <% end %>
  <% if @sprint.has_burndown? %>
    <li class="toolbar-item">
      <%= show_burndown_link(@sprint) %>
    </li>
  <% end %>
<% end %>

<% breadcrumb_paths(link_to(l(:label_backlogs), backlogs_project_backlogs_path(@project)), link_to(@sprint.name, backlogs_project_backlogs_path(@sprint))) %>

<div id='rb'>
    <div id="taskboard" class="wp-work-wrapper">
        <div id="wp-work" class="wp-work" style="height: 330px;">
            <div id="wp-pool-column">
                <div id="wp-pool" style="display: block; padding-top: 36px;">
                    <div id="wp-column-header-group" class="wp-column-header-group wp-fixed">
                        <ul id="wp-column-headers" class="wp-column-headers">                            
                            <% @statuses.each do |status| %>
                              <li class="wp-column">
                                <div class="wp-column-header-flex">
                                    <div class="wp-column-header-flex-1">
                                      <h2><%= status.name %></h2>
                                      </div>
                                  </div>
                              </li>
                            <% end %>
                        </ul>                        
                    </div>

                    <%#-- SCRUM BOARD ++#%>
                    <% if isKanbanboard(@project) == false %>
                      <% if @sprint.stories(@project).any? %>
                        <% @sprint.stories(@project).each do |story| %>
                          <div class="wp-swimlane wp-first <%= story_html_id_or_empty(story) %>"> 
                            <div class="wp-swimlane-header">
                              <div role="button" tabindex="0" class="wp-expander">
                                <span class="wp-iconfont wp-iconfont-expanded"></span>
                              </div>                          
                                <div class="wp-heading story <%= mark_if_closed(story) %>" id="<%= story_html_id_or_empty(story) %>">
                                    <span class="wp-swimlane-avatar">
                                    <%= image_tag task_type_icon(story), class: "" %>
                                    </span>
                                    
                                    <%= work_package_link_or_empty(story) %>
                                    <span class="wp-info">
                                        <span class="aui-lozenge"><%= story.status.name %></span>
                                    </span>
                                    <span class="wp-summary"> 
                                        <%= story.subject %>
                                    </span>
                                </div>
                              </div>

                              <div id="tasks">     
                                <ul class="wp-columns">
                                    <% @statuses.each do |status| %>
                                      <li class="wp-column swimlane list <%= status.is_closed? ? 'closed' : '' %>" id="<%= story.id %>_<%= status.id %>">
                                          <%= render :partial => "rb_tasks/task",
                                                  :collection => story.tasks.select { |task| task.status.id == status.id } %>
                                      </li>
                                    <% end %>
                                  </ul>
                              </div>
                          </div>
                        <% end %>
                      <% else %>
                          <div class="no-data">
                            <div class="no-data-content">
                              <span class="no-data-img"></span>
                              <span class="no-data-title">There are no tasks for this scrum board</span>
                            </div>
                          </div>
                      <% end %>
                    <% end %>
                   

                    <%#-- KANBAN BOARD ++#%>
                    <% if isKanbanboard(@project) == true %>
                      <% if @sprint.stories(@project).any? %>
                            <div class="wp-swimlane wp-first">
                              <div id="tasks">     
                                  <ul class="wp-columns">
                                      <% @statuses.each do |status| %>
                                        <li class="wp-column swimlane list <%= status.is_closed? ? 'closed' : '' %>" id="_<%= status.id %>">
                                          <% @sprint.stories(@project).each do |story| %>
                                            <% if story.status.id == status.id %>    
                                                <% prevent_edit = User.current.allowed_to?(:edit_work_packages, defined?(project) ? project : story.project) ? '' : 'prevent_edit'%>
                                                <div class="model work_package task <%= color_contrast_class(story) %> <%= prevent_edit %> <%= mark_if_closed(story) %>" id="work_package_<%= story.id %>" <%= build_inline_style(story) %>>
                                                  <div class="id">
                                                    <div class="t"><%= work_package_link_or_empty(story) %></div>
                                                    <div class="v"><%= id_or_empty(story) %></div>
                                                  </div>

                                                  <div class="task_type"><%= image_tag task_type_icon(story), class: "" %></div>
                                                  <div class="task_priority"><%= image_tag task_priority_icon(story), class: "" %></div>

                                                  <div class="subject editable" fieldtype="textarea" fieldname="subject" field_id=<%= story.id %>><%= story.subject %></div>

                                                  <div class="assigned_to_id editable" fieldtype="select" fieldname="assigned_to_id" field_id=<%= story.id %>>
                                                    <div class="t"><%= assignee_name_or_empty(story) %></div>
                                                    <div class="v"><%= assignee_id_or_empty(story) %></div>
                                                  </div>

                                                  <div class="remaining_hours editable<%= ' empty' if remaining_hours(story).blank? %>" fieldname="remaining_hours"><%= remaining_hours(story) %></div>

                                                    
                                                  <div class="indicator"> </div>
                                                  <div class="meta">
                                                    <div class="story_id"><%= story.parent_id %></div>
                                                    <div class="status_id"><%= story.status_id %></div>
                                                    <%= render :partial => "shared/model_errors", :object => story.errors %>
                                                  </div>
                                                </div>
                                            <% end %>
                                          <% end %>
                                        </li>
                                      <% end %>
                                  </ul>
                              </div>
                            </div>
                      <% else %>
                        <div class="no-data">
                          <div class="no-data-content">
                            <span class="no-data-img"></span>
                            <span class="no-data-title">There are no tasks for this kanban board</span>
                          </div>
                        </div>
                      <% end %>
                    <% end %>
                </div>
            </div>
        </div>
    </div> 
  
  
  

  <div id="helpers">
    <select class="assigned_to_id template" id="assigned_to_id_options">
      <option value=""> </option>
      <% @project.possible_assignees.each do |user| %>
        <option value="<%= user.id %>" color="<%= get_backlogs_preference(user, :task_color) %>">
          <%= user.name %>
        </option>
      <% end %>
    </select>
    <div id="task_template">
      <%= render :partial => "rb_tasks/task", :object => Task.new, :locals => {:project => @project} %>
    </div>
    <div id="impediment_template">
      <%= render :partial => "rb_impediments/impediment", :object => Impediment.new, :locals => {:project => @project} %>
    </div>

    <div id="work_package_editor"> </div>
    <div class="meta" id="last_updated"><%= date_string_with_milliseconds( (@last_updated.blank? ? Time.now : @last_updated.updated_at) )  %></div>
    <div id="charts"> </div>
    <div id="preloader">
      <div id="spinner"> </div>
      <div id="warning"> </div>
    </div>
  </div>
</div>